alias: Calendar Travel Notification - Kia
description: Hybrid Trigger - Fixed 5min Warning Logic
triggers:
  - trigger: calendar
    event: start
    offset: "-03:00:00"
    entity_id: calendar.your_calendar
    id: calendar_offset
  - minutes: /1
    trigger: time_pattern
    id: pulse_check
actions:
  - variables:
      warn_1_mins: 30   #<-- Sets the Time Prior to the first warning - default is 30 mins
      warn_2_mins: 5 #<-- Sets the time prior to the 2nd warning - default is 5 mins
      fuel_buffer_mins: 15 #<-- Sets the fuel time buffer - the time added to travel time to add fuel - default is 15 mins
      my_calendar: your_calendar #<-- You Calendar Entires
      my_speakers: media_player.speaker_group #<-- Google Home speaker group you wish to play the notification on
      my_kia_range: sensor.tasman_total_driving_range #<-- Double check this, this is the sensor for total driving range I had for my Tasman (will be different for other models)
      my_notify_service: notify.mobile_app_your_mobile #<-- change your_mobile to the phone listed in devices
      my_tts_engine: tts.google_translate_en_com_au #<-- This is Australian, again check the cast sensors
      my_person: person.you #<-- Update you to your name in Home Assistant
      event_name: "{{ state_attr(my_calendar, 'message') }}"
      description: "{{ state_attr(my_calendar, 'description') | default('', true) }}"
      is_public_transport: "{{ 'Public Transport' in description }}"
      event_start: "{{ as_timestamp(state_attr(my_calendar, 'start_time'), 0) }}"
      now_ts: "{{ as_timestamp(now()) }}"
      trip_dist: >-
        {{ state_attr('sensor.waze_travel_time', 'distance') | float(0) |
        round(1) }}
      current_range: "{{ states(my_kia_range) | float(0) }}"
      needs_fuel: "{{ not is_public_transport and current_range < (trip_dist + 60) }}"
      fuel_buffer_sec: "{{ fuel_buffer_mins * 60 if needs_fuel else 0 }}"
      travel_seconds: "{{ (states('sensor.waze_travel_time') | int(0) * 60) }}"
      leave_at_ts: "{{ event_start - travel_seconds - fuel_buffer_sec }}"
      warn_1_ts: "{{ leave_at_ts - (warn_1_mins * 60) }}"
      warn_2_ts: "{{ leave_at_ts - (warn_2_mins * 60) }}"
      leave_time_str: "{{ leave_at_ts | timestamp_custom('%I:%M %p', true, 'Unknown') }}"
      fuel_msg: >-
        {{ 'including an extra ' ~ fuel_buffer_mins ~ ' minutes to refuel the
        Tasman' if needs_fuel else '' }}
      last_ran: "{{ as_timestamp(state_attr(this.entity_id, 'last_triggered'), 0) }}"
  - condition: template
    value_template: "{{ event_name is not none and now_ts < (leave_at_ts + 60) }}"
  - choose:
      - conditions:
          - condition: template
            value_template: >-
              {{ warn_1_ts <= now_ts < (warn_1_ts + 60) and (now_ts - last_ran)
              > 120 }}
        sequence:
          - action: "{{ my_notify_service }}"
            data:
              title: "Trip Alert: {{ event_name }}"
              message: >-
                Leave at {{ leave_time_str }}. {{ 'Fuel stop needed' if
                needs_fuel else '' }}
          - if:
              - condition: template
                value_template: "{{ is_state(my_person, 'home') }}"
            then:
              - action: media_player.volume_set
                target:
                  entity_id: "{{ my_speakers }}"
                data:
                  volume_level: 1
              - action: tts.speak
                target:
                  entity_id: "{{ my_tts_engine }}"
                data:
                  media_player_entity_id: "{{ my_speakers }}"
                  message: >
                    Attention, {{ warn_1_mins }} minute warning for {{ event_name
                    }}.  You should leave at {{ leave_time_str }} {{ fuel_msg
                    }}.
              - delay: "00:00:15"
              - action: media_player.media_stop
                target:
                  entity_id: "{{ my_speakers }}"
              - action: media_player.volume_set
                target:
                  entity_id: "{{ my_speakers }}"
                data:
                  volume_level: 0.7
      - conditions:
          - condition: template
            value_template: >-
              {{ warn_2_ts <= now_ts < (warn_2_ts + 60) and (now_ts - last_ran)
              > 120 }}
        sequence:
          - if:
              - condition: template
                value_template: "{{ is_state(my_person, 'home') }}"
            then:
              - action: media_player.volume_set
                target:
                  entity_id: "{{ my_speakers }}"
                data:
                  volume_level: 1
              - action: tts.speak
                target:
                  entity_id: "{{ my_tts_engine }}"
                data:
                  media_player_entity_id: "{{ my_speakers }}"
                  message: >-
                    Final reminder. You need to leave for {{ event_name
                    }} in {{ warn_2_mins }} minutes. {{ 'Don''t forget to stop
                    for fuel.' if needs_fuel else '' }}
              - delay: "00:00:12"
              - action: media_player.media_stop
                target:
                  entity_id: "{{ my_speakers }}"
              - action: media_player.volume_set
                target:
                  entity_id: "{{ my_speakers }}"
                data:
                  volume_level: 0.7
mode: restart
